<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal de Chamada - Col√©gio Carbonell</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Estilos dos filtros (sem altera√ß√µes)
           Coment√°rios aqui apenas descrevem a finalidade visual das classes CSS.
           N√£o alteramos regras CSS existentes ‚Äî apenas documentamos. */
        .filter-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn { display: inline-block; }
        .filter-btn input[type="radio"] { display: none; }
        .filter-btn label { padding: 10px 20px; font-size: 0.9em; font-weight: bold; background-color: var(--carbonell-azul-escuro); color: var(--carbonell-branco); border: 2px solid var(--carbonell-azul-escuro); border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .filter-btn input[type="radio"]:checked+label { background-color: var(--carbonell-amarelo); color: var(--carbonell-azul-marinho); border-color: var(--carbonell-amarelo); }

        /* --- NOVOS ESTILOS: MODAL DE CONFIRMA√á√ÉO --- */
        /* Documenta√ß√£o: Estes estilos criam a apar√™ncia do modal de confirma√ß√£o usado na
           a√ß√£o "Limpar Tudo". O modal √© composto por uma sobreposi√ß√£o (overlay) que
           cobre a tela inteira e uma caixa centralizada com conte√∫do e bot√µes. */

        /* A sobreposi√ß√£o escura que cobre a tela inteira */
        .modal-overlay {
            position: fixed; /* Mant√©m o overlay fixo mesmo com rolagem */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Fundo preto semitransparente */
            display: none; /* Inicia escondido; vis√≠vel quando display='flex' */
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Deve ficar acima de outros elementos da UI */
        }

        /* A caixa de di√°logo do modal */
        .modal-content {
            background-color: var(--carbonell-branco);
            color: var(--carbonell-azul-marinho);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .modal-content h2 { margin-top: 0; }

        /* Container para os bot√µes de a√ß√£o dentro do modal */
        .modal-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px; /* Espa√ßamento entre os bot√µes */
        }
        /* --- FIM DOS NOVOS ESTILOS --- */
    </style>
</head>

<body class="terminal-body">
    <div class="container terminal-container">
        <header>
            <div class="header-left">
                <!-- Logo da institui√ß√£o e t√≠tulo da p√°gina -->
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo Col√©gio Carbonell" class="logo">
                <h1>Terminal de Chamada</h1>
            </div>
            <div class="header-right">
                <!-- Bot√£o que aciona a limpeza de todos os pain√©is (abre modal de confirma√ß√£o) -->
                <button class="btn btn-danger" id="clear-all-btn">Limpar Tudo</button>
                <div class="user-info">
                    <!-- Exibe o nome do usu√°rio logado (obtido pela sess√£o Flask) -->
                    <span>Logado como: {{ session['user']['name'] }}</span>
                    <a href="{{ url_for('logout') }}" class="logout-button">Sair</a>
                </div>
            </div>
        </header>

        <main>
            <!-- Filtros por grupo (Todos / Ed. Infantil / Anos Iniciais / Anos Finais) -->
            <div class="filter-container" id="grupo-filter">
                <div class="filter-btn"><input type="radio" id="filter-todos" name="grupo" value="todos" checked><label for="filter-todos">Todos</label></div>
                <div class="filter-btn"><input type="radio" id="filter-ei" name="grupo" value="EI"><label for="filter-ei">Ed. Infantil</label></div>
                <div class="filter-btn"><input type="radio" id="filter-ai" name="grupo" value="AI"><label for="filter-ai">Anos Iniciais</label></div>
                <div class="filter-btn"><input type="radio" id="filter-af" name="grupo" value="AF"><label for="filter-af">Anos Finais</label></div>
            </div>

            <!-- Barra de busca: campo de texto, bot√£o limpar, bot√£o buscar e microfone para busca por voz -->
            <form class="search-bar" id="search-form">
                <input type="text" id="search-input" placeholder="Digite o nome do aluno para buscar..." autocomplete="off">
                <button type="button" class="btn" id="clear-search-btn" aria-label="Limpar campo de busca">üóëÔ∏è</button>
                <button type="submit" class="btn" id="search-btn">Buscar</button>
                <button type="button" class="btn" id="mic-btn" aria-label="Iniciar busca por voz">üé§</button>
                </form>
            <div id="search-results"></div> <!-- Container onde os resultados da busca ser√£o renderizados -->
        </main>
    </div>

    <!-- Modal de confirma√ß√£o para a a√ß√£o 'Limpar Tudo' -->
    <div id="confirmation-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Confirmar A√ß√£o</h2>
            <p>Tem certeza que deseja limpar TODOS os pain√©is (Infantil e Fundamental)? Esta a√ß√£o n√£o pode ser desfeita.</p>
            <div class="modal-actions">
                <button id="modal-cancel-btn" class="btn">Cancelar</button>
                <button id="modal-confirm-btn" class="btn btn-danger">Confirmar Limpeza</button>
            </div>
        </div>
    </div>
    <script type="module" src="{{ url_for('static', filename='firebase-config.js') }}"></script>
    <script type="module">
        /*
         * Script do terminal de chamada
         * - Linguagem: JavaScript (ES modules)
         * - Objetivo: fornecer interatividade para buscar alunos, chamar alunos e limpar pain√©is
         * - Integra√ß√£o com Firebase Firestore para opera√ß√µes de leitura/exclus√£o (apenas leitura/exclus√£o neste arquivo)
         *
         * Observa√ß√£o: N√£o altere vari√°veis ou l√≥gica; adicionamos apenas coment√°rios explicativos.
         */
        import { db } from '/static/firebase-config.js';
        import { collection, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

        // --- REFER√äNCIAS AOS ELEMENTOS HTML ---
        // Cada constante armazena uma refer√™ncia a um elemento do DOM usado no script.
        const searchForm = document.getElementById('search-form'); // Form que cont√©m campo de busca
        const searchInput = document.getElementById('search-input'); // Campo de texto da busca
        const micBtn = document.getElementById('mic-btn'); // Bot√£o para iniciar busca por voz
        const searchResultsContainer = document.getElementById('search-results'); // Onde os resultados ser√£o exibidos
        const clearAllBtn = document.getElementById('clear-all-btn'); // Bot√£o que abre modal de confirma√ß√£o para limpar
        const searchBtn = document.getElementById('search-btn'); // Bot√£o de submit da busca
        const clearSearchBtn = document.getElementById('clear-search-btn'); // Bot√£o para limpar input de busca
        const defaultAvatar = "https://www.gravatar.com/avatar/0?d=mp&f=y"; // Avatar padr√£o caso foto n√£o exista

        // --- REFER√äNCIAS DO MODAL ---
        // Elementos que comp√µem o modal de confirma√ß√£o usado antes de executar a a√ß√£o destrutiva
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        /**
         * displayResults(students)
         * - Prop√≥sito: renderizar a lista de alunos retornada pela API de busca.
         * - Par√¢metros:
         *    students: Array de objetos representando alunos. Cada objeto deve conter ao menos
         *              { id, nomeCompleto, turma, fotoUrl? }.
         * - Retorno: void (renderiza diretamente no DOM)
         * - Observa√ß√µes:
         *    - Caso nenhum aluno seja encontrado, exibe uma mensagem amig√°vel.
         *    - Para cada aluno √© criado um bloco com foto, nome, turma e bot√£o "Chamar".
         *    - O bot√£o "Chamar" chama a fun√ß√£o callStudent com os dados necess√°rios. N√£o altera
         *      o objeto original, apenas cria um objeto reduzido (studentDataForCall).
         */
        const displayResults = (students) => {
            searchResultsContainer.innerHTML = '';
            if (students.length === 0) {
                searchResultsContainer.innerHTML = '<p style="text-align: center; color: white;">Nenhum aluno encontrado.</p>';
                return;
            }
            students.forEach(student => {
                const studentDiv = document.createElement('div');
                studentDiv.className = 'student-result-item';
                let photoSrc = defaultAvatar;
                // Se o aluno possui foto, decide se j√° √© dataURI ou se precisa montar base64
                if (student.fotoUrl) {
                    photoSrc = student.fotoUrl.startsWith('data:image') ? student.fotoUrl : `data:image/jpeg;base64,${student.fotoUrl}`;
                }
                studentDiv.innerHTML = `
                    <img src="${photoSrc}" alt="Foto de ${student.nomeCompleto}" class="student-photo-small">
                    <div class="student-info">
                        <span class="student-name">${student.nomeCompleto}</span>
                        <span class="student-class">${student.turma}</span>
                    </div>
                    <button class="btn btn-action">Chamar</button>
                `;

                // Associa evento ao bot√£o de chamar: cria um objeto com os campos esperados pela API
                studentDiv.querySelector('.btn-action').addEventListener('click', (event) => {
                    const studentDataForCall = {
                        id: student.id,
                        nomeCompleto: student.nomeCompleto,
                        turma: student.turma,
                        fotoUrl: photoSrc
                    };
                    // Chama a fun√ß√£o respons√°vel por notificar o backend e atualizar UI local
                    callStudent(studentDataForCall, event.target);
                });
                searchResultsContainer.appendChild(studentDiv);
            });
        };

        /**
         * fetchStudents(searchTerm)
         * - Prop√≥sito: consultar a API backend para buscar alunos por parte do nome.
         * - Par√¢metros:
         *    searchTerm: string ‚Äî termo de busca inserido pelo usu√°rio.
         * - Retorno: Promise<void> (realiza fetch e renderiza resultados via displayResults)
         * - Valida√ß√µes/edge cases:
         *    - Requer pelo menos 2 caracteres para evitar consultas in√∫teis ao servidor.
         *    - Desabilita o bot√£o de buscar enquanto a requisi√ß√£o est√° em andamento.
         *    - Em caso de erro de rede ou resposta inv√°lida, exibe mensagem de erro.
         */
        const fetchStudents = async (searchTerm) => {
            const cleanedSearchTerm = searchTerm.trim();
            if (cleanedSearchTerm.length < 2) {
                searchResultsContainer.innerHTML = '<p style="text-align: center; color: white;">Digite pelo menos 2 letras para buscar.</p>';
                return;
            }
            // L√™ o filtro de grupo atualmente selecionado (Todos/EI/AI/AF)
            const selectedGrupo = document.querySelector('input[name="grupo"]:checked').value;
            searchBtn.disabled = true; // Previne m√∫ltiplos envios
            searchBtn.textContent = 'Buscando...';
            searchResultsContainer.innerHTML = '<p style="text-align: center; color: white;">Buscando...</p>';
            try {
                // Monta a URL da API com encoding seguro dos par√¢metros
                const url = `/api/buscar-aluno?parteNome=${encodeURIComponent(cleanedSearchTerm)}&grupo=${selectedGrupo}`;
                const response = await fetch(url);
                const students = await response.json();
                // Observa√ß√£o: assumimos que a API retorna um array JSON. Se retornar outro formato,
                // pode ocorrer erro ao chamar displayResults.
                displayResults(students);
            } catch (error) {
                // Tratamento b√°sico de erro: log no console e mensagem amig√°vel ao usu√°rio
                console.error('Erro ao buscar alunos:', error);
                searchResultsContainer.innerHTML = '<p style="text-align: center; color: white;">Erro ao conectar com o servidor.</p>';
            } finally {
                // Restaura o estado do bot√£o independente do resultado
                searchBtn.disabled = false;
                searchBtn.textContent = 'Buscar';
            }
        };
        
        /**
         * callStudent(studentData, buttonElement)
         * - Prop√≥sito: enviar requisi√ß√£o ao backend para "chamar" o aluno (registro de chamado)
         * - Par√¢metros:
         *    studentData: objeto contendo pelo menos { id, nomeCompleto, turma, fotoUrl }
         *    buttonElement: refer√™ncia ao bot√£o clicado para atualizar o estado visual do bot√£o
         * - Retorno: Promise<void>
         * - Observa√ß√µes de erro:
         *    - Se a requisi√ß√£o falhar por rede, atualiza o bot√£o para indicar erro de rede.
         *    - Se o servidor responder com c√≥digo n√£o-ok, exibe estado de erro no bot√£o.
         */
        const callStudent = async (studentData, buttonElement) => {
            buttonElement.textContent = "Chamando...";
            buttonElement.disabled = true;
            try {
                const response = await fetch('/api/chamar-aluno', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentData)
                });
                if (response.ok) {
                    // Sucesso: feedback visual positivo
                    buttonElement.textContent = "Chamado!";
                    buttonElement.style.backgroundColor = '#5cb85c';
                } else {
                    // Resposta do servidor indica falha na opera√ß√£o
                    buttonElement.textContent = "Erro!";
                    buttonElement.style.backgroundColor = '#d9534f';
                }
            } catch (error) {
                // Erro de rede (ex: desconex√£o) ‚Äî log e feedback ao usu√°rio
                console.error('Erro de rede ao chamar aluno:', error);
                buttonElement.textContent = "Erro de Rede!";
                buttonElement.style.backgroundColor = '#d9534f';
            }
        };

        /**
         * executeClearAll()
         * - Prop√≥sito: remover todos os documentos das cole√ß√µes relevantes no Firestore.
         * - Sem par√¢metros e retorna Promise<void>.
         * - Fluxo:
         *    1) Desabilita e atualiza o bot√£o "Limpar Tudo" para informar progresso.
         *    2) Faz leitura das cole√ß√µes listadas em collectionsToClear e gera promessas de
         *       exclus√£o para cada documento encontrado.
         *    3) Aguarda Promise.all(deletePromises) para confirmar exclus√µes em paralelo.
         *    4) Em caso de erro, loga no console e informa o usu√°rio via alert().
         * - Observa√ß√µes / riscos:
         *    - Esta fun√ß√£o realiza exclus√µes definitivas no Firestore ‚Äî deve ser usada apenas
         *      ap√≥s confirma√ß√£o do usu√°rio.
         *    - Pode haver limites de taxa (rate limits) ou regras de seguran√ßa no Firestore que
         *      impe√ßam dele√ß√µes em massa; esses erros s√£o capturados no bloco catch.
         */
        const executeClearAll = async () => {
            clearAllBtn.textContent = "Limpando...";
            clearAllBtn.disabled = true;
            const collectionsToClear = ["chamados", "chamados_ei", "chamados_fund"];
            try {
                const deletePromises = [];
                for (const collName of collectionsToClear) {
                    // L√™ todos os documentos da cole√ß√£o
                    const snapshot = await getDocs(collection(db, collName));
                    snapshot.docs.forEach(studentDoc => {
                        // Para cada documento, cria uma promessa de exclus√£o
                        deletePromises.push(deleteDoc(doc(db, collName, studentDoc.id)));
                    });
                }
                // Aguarda exclus√£o paralela de todos os documentos
                await Promise.all(deletePromises);
                // Feedback simples ao usu√°rio; em produ√ß√£o, considerar um toast n√£o bloqueante
                alert("Pain√©is limpos com sucesso!");
            } catch (error) {
                console.error("Erro ao limpar os pain√©is: ", error);
                alert("Ocorreu um erro ao tentar limpar os pain√©is.");
            } finally {
                // Restaura estado do bot√£o independentemente do resultado
                clearAllBtn.textContent = "Limpar Tudo";
                clearAllBtn.disabled = false;
            }
        };

        // Placeholder para a l√≥gica de busca por voz. Coment√°rio explica objetivo.
        const handleVoiceSearch = () => { /* Fun√ß√£o respons√°vel por iniciar reconhecimento de voz e chamar fetchStudents com o termo reconhecido. */ };

        // --- EVENT LISTENERS (OUVINTES DE EVENTOS) ---

        // Evento de 'submit' do formul√°rio (clicar em Buscar ou pressionar Enter)
        searchForm.addEventListener('submit', (event) => {
            event.preventDefault();
            fetchStudents(searchInput.value);
        });

        // Evento do bot√£o de limpar o campo de busca
        clearSearchBtn.addEventListener('click', () => {
            // Limpa o input, limpa os resultados e move o foco de volta para o campo
            searchInput.value = '';
            searchResultsContainer.innerHTML = '';
            searchInput.focus();
        });

        // Evento do bot√£o de busca por voz (ainda n√£o implementado integralmente nesta view)
        micBtn.addEventListener('click', handleVoiceSearch);

        // --- L√ìGICA DO MODAL DE CONFIRMA√á√ÉO ---
        // Observa√ß√£o: em vez de executar a exclus√£o diretamente no clique do bot√£o "Limpar Tudo",
        // abrimos um modal para confirmar a a√ß√£o (melhor pr√°tica para a√ß√µes destrutivas).

        // 1. Evento para ABRIR o modal
        clearAllBtn.addEventListener('click', () => {
            confirmationModal.style.display = 'flex'; // Torna o modal vis√≠vel (display flex usado nos estilos)
        });

        // 2. Evento para o bot√£o de CANCELAR dentro do modal ‚Äî apenas esconde o modal
        modalCancelBtn.addEventListener('click', () => {
            confirmationModal.style.display = 'none';
        });

        // 3. Evento para o bot√£o de CONFIRMAR dentro do modal ‚Äî esconde o modal e executa a limpeza
        modalConfirmBtn.addEventListener('click', () => {
            confirmationModal.style.display = 'none';
            executeClearAll(); // Aciona fun√ß√£o que realiza exclus√µes no Firestore
        });

        // Opcional: fechar o modal se o usu√°rio clicar fora da caixa de di√°logo
        window.addEventListener('click', (event) => {
            if (event.target === confirmationModal) {
                confirmationModal.style.display = 'none';
            }
        });
        // --- FIM DA L√ìGICA ---
    </script>
</body>
</html>